# TTTK 251010

# Start Log
- 20251010 16:17
- 작업자 : ykd0638

### To Do

**목표**: 마차 시스템 완성 - 남은 Phase 3 & 4 작업 완료

**현재 상태**:
- Phase 1 & 2 완료 (기본 이동 시스템, 정류장 시스템)
- Phase 4-6 완료 (지면 추적, 멀티플레이 복제 설정)
- Working Tree: Clean 상태

---

#### 다음 단계 작업 항목

1. **"현재 프로젝트 상태 확인"**
   - 마차 관련 코드 최신 상태 확인
   - Interactable 시스템 머지 여부 확인
   - 팀원 작업 진행 상황 파악

2. **"작업 우선순위 결정"**
   - Phase 3 (탑승/하차 시스템) 진행 가능 여부 판단
   - 또는 Phase 4-5 (정류장 이벤트 멀티플레이 동기화) 먼저 진행 여부 결정
   - 사용자와 작업 방향 논의

3. **"다음 기능 구현"**
   - 결정된 우선순위에 따라 구현 시작

---

## Compact Log 1
- 20251010 18:49

### 요약 내용

**마차 승하차 시스템 완성**

Interactable 시스템 머지 전까지 MainPlayer에 임시 구현 후 이관하는 방식으로 Phase 3 (탑승/하차 시스템) 완료

#### 1. 정류장 시스템 버그 수정
- **문제**: 런타임에서 정류장이 수집되지 않음 (0개 수집)
- **원인**: `CollectStopPoint()`가 `OnConstruction()` (#if WITH_EDITOR)에서만 호출됨
- **해결**: `CarriagePathActor::BeginPlay()`에서도 `CollectStopPoint()` 호출 추가
- **결과**: Play 시작 시 정류장 자동 수집

#### 2. 좌석 시스템 구현
- **Seat1, Seat2** SceneComponent 추가 (최대 2명 탑승)
- 좌석 위치 및 회전 설정 (`SetRelativeRotation(0, 90, 0)` - 마차 전방 향함)
- 탑승 시 좌석 방향으로 플레이어 회전 통일
- 컨트롤러 회전도 마차 방향으로 리셋 (`SetControlRotation`)

#### 3. 탑승자 관리 시스템
- **PassengerList** (Replicated) 추가 - 최대 2명 제한
- **PlayersInRange** (BoardArea Overlap으로 관리)
- 좌석 인덱스 자동 할당 (`GetAvailableSeatIndex()`)
- 탑승 가능 여부 체크 (`CanBoardCarriage()` - 정차 중 + 빈 좌석)

#### 4. 네트워크 동기화 시스템
- **CurrentStopPoint** Replicated 추가 (클라이언트도 정차 상태 확인 가능)
- **RPC 구조 수정**:
  - 문제: 클라이언트가 `CarriageVehicle.Server_RequestBoard()` 직접 호출 불가 (소유권 없음)
  - 해결: `MainPlayer.Server_RequestBoardCarriage()` → `CarriageVehicle.Server_RequestBoard()` 2단계 RPC
- **Multicast 함수에서 상태 설정**:
  - `bIsRidingCarriage`, `CurrentCarriage` 설정을 Multicast에서 처리
  - 로컬 플레이어만 카메라 전환 (`IsLocallyControlled()` 체크)

#### 5. 탑승/하차 기능
- **탑승 트리거**: F키 (정류장 정차 중 + 5m 반경 내)
- **탑승 처리**:
  - 플레이어를 좌석에 Attach
  - 콜리전 완전 비활성화 (`SetCollisionEnabled(NoCollision)`)
  - 1인칭 카메라 전환 (`SpringArm TargetArmLength = 0`)
  - 애니메이션: 애님 블루프린트 State Machine (bIsRidingCarriage 변수 활용)
- **하차 처리**:
  - 정류장 정차 중에만 F키로 하차 가능
  - Detach 후 BoardArea 옆 위치로 이동
  - 콜리전 복구 (`QueryAndPhysics`)
  - 3인칭 카메라 복귀
  - Input Mapping 복구

#### 6. 디버깅 및 테스트
- 멀티플레이 2명 탑승 테스트 진행 중
- 디버그 로그 추가 (F키 입력, 마차 발견 여부 등)

### Commit 정보

**Feat: 마차 승하차 시스템 구현**

1. **정류장 시스템 버그 수정**
   - CarriagePathActor BeginPlay에서 CollectStopPoint 호출 추가
   - 런타임 정류장 수집 문제 해결

2. **좌석 시스템 및 탑승자 관리**
   - Seat1, Seat2 SceneComponent 추가 (최대 2명)
   - PassengerList Replicated 배열로 탑승자 관리
   - 좌석 회전 설정으로 플레이어 방향 통일

3. **멀티플레이 네트워크 동기화**
   - CurrentStopPoint Replicated 추가
   - MainPlayer Server RPC를 통한 2단계 RPC 구조
   - Multicast에서 bIsRidingCarriage 상태 동기화

4. **탑승/하차 기능 구현**
   - F키 탑승: 정류장 정차 중 + 5m 반경
   - Attach, 콜리전 비활성화, 1인칭 카메라 전환
   - F키 하차: 정류장 정차 중에만 가능
   - 애니메이션: 애님 블루프린트 State Machine 활용

5. **구현 파일**
   - CarriagePathActor.cpp: BeginPlay CollectStopPoint
   - CarriageMovementComponent.h/cpp: CurrentStopPoint Replicated
   - CarriageVehicle.h/cpp: 좌석, 탑승자 관리, RPC 함수들
   - MainPlayer.h/cpp: 탑승/하차 함수, Server RPC, 카메라 전환

---

## End Log
- 20251010 18:52
- 작업자 : ykd0638

### 오늘 한 일

1. **마차 승하차 시스템 완성 (Phase 3)**
   - 정류장 런타임 수집 버그 수정
   - 좌석 시스템 구현 (최대 2명)
   - 탑승자 관리 및 네트워크 동기화
   - F키 탑승/하차 기능 완성

2. **멀티플레이 네트워크 동기화**
   - RPC 구조 설계 및 구현 (2단계 RPC)
   - Replicated 변수 설정
   - Multicast 함수로 상태 동기화

3. **디버깅 및 테스트**
   - 멀티플레이 2명 탑승 테스트
   - RPC 소유권 문제 해결
   - 디버그 로그 추가

### 다음 작업

- **빌드 및 최종 테스트** (멀티플레이 2명 탑승/하차 검증)
- **Input Mapping 전환** (탑승 중 마우스+F키만 허용)
- Interactable 시스템 머지 후 코드 이관
- 정류장 도착/출발 이벤트 멀티플레이 동기화 (Phase 4-5)

---

