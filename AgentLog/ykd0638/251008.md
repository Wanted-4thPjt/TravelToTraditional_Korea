# TTTK 251008

# Start Log
- 20251008 14:00 (추정)
- 작업자 : ykd0638

### To Do

**목표**: 마차 시스템 구현 (오늘~내일)
- 사전 정의 경로를 따라 이동하는 마차
- NPC를 통한 탑승 시스템
- 탑승 시 입력 제한 (마우스/F키만, WASD 비활성화)

#### Phase 1: 핵심 시스템 설계 및 구조

1. "마차 시스템 설계 및 아키텍처 검토"
   - Component 기반 구조 설계
   - 필요한 클래스 및 인터페이스 정의
   - 멀티플레이 고려사항 검토

2. "경로 데이터 구조 설계 (Spline 기반)"
   - SplineComponent를 이용한 경로 정의
   - 경로 데이터 관리 방법
   - 경로 편집 방법 (Blueprint/Editor)

#### Phase 2: 마차 이동 시스템

3. "마차 Actor 클래스 구현"
   - 기본 마차 Actor 생성
   - Mesh, Collision 설정
   - Component 구성

4. "경로 따라가기 이동 로직 구현"
   - Spline 기반 이동 알고리즘
   - 속도, 회전 처리
   - 순환/왕복 옵션

#### Phase 3: 탑승 시스템

5. "NPC 상호작용 시스템 구현 (마차 탑승 요청)"
   - NPC 대화/상호작용 인터페이스
   - 마차 탑승 요청 플로우

6. "탑승 시스템 구현 (플레이어 -> 마차)"
   - 플레이어 위치 고정 (Attach)
   - 카메라 처리
   - 탑승 상태 관리

7. "탑승자 입력 제한 (WASD 비활성화, 마우스/F키만 허용)"
   - Enhanced Input 시스템 제어
   - Input Mapping Context 전환
   - 허용된 입력만 활성화

8. "하차 시스템 구현"
   - 하차 트리거 (특정 지점/플레이어 요청)
   - Detach 및 입력 복구

#### Phase 4: 멀티플레이 및 완성

9. "멀티플레이 동기화 (Replication) 구현"
   - 마차 위치/상태 Replication
   - 탑승자 정보 동기화
   - RPC 처리

10. "마차 시스템 테스트 및 검증"
    - 단일/멀티 플레이 테스트
    - 엣지 케이스 검증
    - 최적화

## Compact Log 1
- 20251008 17:41

### 요약 내용

**Phase 1 & 2 완료: 마차 기본 이동 시스템 구현 완료**

#### 1. 아키텍처 설계
- **Component 기반 구조** 채택
  - `ACarriageVehicle`: 마차 메인 Actor
  - `UCarriageMovementComponent`: 이동 로직 담당 Component
  - `ACarriagePathActor`: Spline 기반 경로 Actor
  - `ACarriageStopPoint`: 정류장 Actor

- **Timer 기반 이동** 방식 선택 (Tick 최소화 원칙)
  - 60fps (0.016초) 간격으로 UpdateMovement 호출
  - Server Authority 구조로 멀티플레이 대응

#### 2. 구현된 주요 클래스

**ACarriageStopPoint** (정류장)
- 정류장 이름, 정차 시간, 방문 상태 관리
- `OnCarriageArrived/OnCarriageDeparted` Blueprint Event
- Editor에서 StopIndex로 순서 지정

**ACarriagePathActor** (경로)
- SplineComponent 기반 경로 정의
- `CollectStopPoints()`: 주변 정류장 자동 수집 (반경 500cm)
- OnConstruction/PostEditChangeProperty에서 자동 갱신
- Distance 기반 위치/회전 Query 함수 제공

**ACarriageVehicle** (마차)
- StaticMeshComponent (마차 Mesh)
- UBoxComponent (BoardArea, 탑승 영역)
- UCarriageMovementComponent (이동 처리)
- PathActor 레퍼런스 (EditInstanceOnly)
- Speed, bLooping 설정

**UCarriageMovementComponent** (이동 Component)
- Timer 기반 경로 추적 (0.016초 간격)
- CurrentDistance 기반 Spline 따라가기
- 정류장 자동 감지 및 정차 (Tolerance 100cm)
- 루프/왕복 모드 지원
- Server Authority 체크

#### 3. 발생 및 해결한 주요 이슈

**Issue #1**: CarriageStopPoint 링커 에러
- 원인: ResetVisited(), PostEditChangeProperty() 선언만 있고 구현 누락
- 해결: .cpp에 구현 추가

**Issue #2**: PathSpline이 None으로 표시
- 원인: ACarriagePathActor 생성자가 비어있어서 CreateDefaultSubobject 호출 안 됨
- 해결: 생성자에서 PathSpline Component 생성 코드 추가

**Issue #3**: PathActor를 레벨에서 선택할 수 없음
- 원인: UPROPERTY가 VisibleAnywhere로 설정됨
- 해결: EditInstanceOnly로 변경하여 인스턴스별 설정 가능하게 수정

**Issue #4**: SetTimer 호출 시 시간 간격 누락
- 원인: MovementComponent의 SetTimer에서 0.016f 인자 누락
- 해결: 0.016f, true 파라미터 추가 및 디버그 로그 추가

#### 4. 현재 상태
- 기본 이동 시스템 코드 구현 완료
- 컴파일 성공
- 디버그 로그 추가 (PathActor 연결 상태 확인용)
- **테스트 대기 중**: 레벨에서 실제 이동 동작 검증 필요

#### 5. 다음 단계 (Phase 3)
- 현재 이동 시스템 동작 확인 후
- 탑승 시스템 구현 (플레이어 Attach)
- Enhanced Input을 이용한 입력 제한 (WASD 비활성화)
- 하차 시스템 구현

### Commit 정보

**Feat: 마차 기본 이동 시스템 구현 (Spline 기반 경로 추적)**

1. **정류장 시스템 (CarriageStopPoint)**
   - 정류장 Actor 생성 및 속성 정의 (이름, 정차시간, 순서)
   - Blueprint Event 연동 (OnCarriageArrived/Departed)

2. **경로 시스템 (CarriagePathActor)**
   - SplineComponent 기반 경로 Actor 구현
   - 정류장 자동 수집 기능 (반경 500cm)
   - Distance 기반 위치/회전 Query API

3. **마차 이동 시스템 (CarriageVehicle & CarriageMovementComponent)**
   - Component 기반 마차 Actor 구조
   - Timer 기반 Spline 경로 추적 로직 (60fps)
   - 정류장 자동 감지 및 정차 시스템
   - Server Authority 기반 멀티플레이 대응
   - 루프/왕복 이동 모드 지원

4. **버그 수정**
   - PathSpline Component 초기화 누락 수정
   - SetTimer 호출 시 시간 간격 파라미터 추가
   - Property Specifier 수정 (EditInstanceOnly)
   - 디버그 로그 추가

---

다음 작업을 위해 `/compact` 명령을 실행하여 컨텍스트를 정리하는 것을 추천합니다.

## End Log
- 20251008 17:41
- 작업자 : ykd0638

### 오늘 한 일

1. **마차 시스템 아키텍처 설계**
   - Component 기반 구조 설계 및 클래스 정의
   - Timer 기반 이동 방식 결정

2. **마차 이동 시스템 구현 (Phase 1 & 2 완료)**
   - 정류장 Actor (ACarriageStopPoint) 구현
   - 경로 Actor (ACarriagePathActor) - SplineComponent 기반
   - 마차 Actor (ACarriageVehicle) 구현
   - 이동 Component (UCarriageMovementComponent) - Timer 기반 경로 추적

3. **주요 기능 구현**
   - Spline 기반 경로 따라가기 로직
   - 정류장 자동 감지 및 정차 시스템
   - 루프/왕복 이동 모드
   - Server Authority 기반 멀티플레이 대응 구조

4. **버그 수정 및 디버깅**
   - 링커 에러, Component 초기화, Property 설정 등 4개 이슈 해결
   - 디버그 로그 추가

---

세션을 종료합니다. 수고하셨습니다!

# Start Log
- 20251008 23:21
- 작업자 : ykd0638

### To Do

**현재 상태**: `MainPlayer.cpp`에 수정사항 있음 (아직 미커밋)

#### 즉시 확인 필요
1. "MainPlayer.cpp 변경사항 확인"
   - 어떤 내용이 변경되었는지 확인
   - 변경 의도 파악
   - 커밋 필요 여부 판단

#### Phase 3: 탑승 시스템 (대기 중)
2. "탑승 시스템 구현 (플레이어 -> 마차)"
   - 플레이어 위치 고정 (Attach)
   - 카메라 처리
   - 탑승 상태 관리

3. "탑승자 입력 제한 (WASD 비활성화, 마우스/F키만 허용)"
   - Enhanced Input 시스템 제어
   - Input Mapping Context 전환
   - 허용된 입력만 활성화

4. "하차 시스템 구현"
   - 하차 트리거 (특정 지점/플레이어 요청)
   - Detach 및 입력 복구

---

## 마차 시스템 아키텍처 문서
- 20251008 23:25

### 1. 시스템 개요

마차 시스템은 **Component 기반 모듈 설계**로 구현되어 있으며, **Timer 기반 이동 방식**을 통해 Tick 사용을 최소화했다. Server Authority 구조로 멀티플레이 환경을 대응한다.

### 2. 핵심 클래스 구조

#### 2.1 ACarriageVehicle (마차 Actor)
**역할**: 마차의 메인 Actor, 모든 컴포넌트의 소유자

**주요 컴포넌트**:
- `UStaticMeshComponent* CarriageMesh`: 마차 시각적 표현 (RootComponent)
- `UCarriageMovementComponent* MovementComponent`: 이동 로직 담당
- `UBoxComponent* BoardArea`: 탑승 영역 (크기: 200x200x100cm)

**주요 속성**:
- `ACarriagePathActor* PathActor`: 따라갈 경로 Actor (EditInstanceOnly)
- `float Speed`: 이동 속도 (기본: 300 cm/s)
- `bool bLooping`: 루프 모드 (true) vs 왕복 모드 (false)

**멀티플레이 설정**:
- `bReplicates = true`
- `SetReplicateMovement(true)`

**주요 함수**:
- `BeginPlay()`: Authority에서만 `StartMovement()` 자동 호출
- `StartMovement()`: MovementComponent에 이동 시작 위임
- `StopMovement()`: MovementComponent에 이동 정지 위임
- `GetPathActor()`: PathActor 반환 (MovementComponent가 접근)

#### 2.2 UCarriageMovementComponent (이동 Component)
**역할**: 마차의 실제 이동 로직 처리

**주요 속성**:
- `float CurrentDistance`: 현재 Spline 상의 거리 (cm 단위)
- `bool bisMoving`: 이동 중 여부
- `bool bisStoped`: 정류장 정차 중 여부
- `float stopTimer`: 정차 남은 시간
- `ACarriageStopPoint* CurrentStopPoint`: 현재 정차 중인 정류장

**내부 캐시**:
- `ACarriageVehicle* OwnerCarriage`: BeginPlay에서 캐싱
- `ACarriagePathActor* CachedPathActor`: BeginPlay에서 PathActor 캐싱
- `FTimerHandle MovementTimerHandle`: Timer 핸들

**핵심 메커니즘**:
1. **Timer 기반 이동** (Tick 대신)
   - 0.016초(60fps) 간격으로 `UpdateMovement()` 호출
   - Server Authority 체크

2. **이동 로직** (`UpdateMovement()`):
   ```
   - 정차 중이면 → UpdateStopTimer() 호출 후 리턴
   - CurrentDistance += Speed * DeltaTime (0.016초)
   - 경로 끝 도달 체크:
     * Looping 모드: CurrentDistance = 0, 모든 정류장 방문 상태 초기화
     * 왕복 모드: Speed 반전 (방향 전환)
   - PathActor에서 위치/회전 조회
   - SetActorLocationAndRotation() 적용
   - CheckStopPoints() 호출
   ```

3. **정류장 체크** (`CheckStopPoints()`):
   ```
   - PathActor에서 현재 거리 기준 가장 가까운 정류장 검색 (Tolerance 100cm)
   - 미방문 정류장 발견 시 → BeginStop() 호출
   ```

4. **정차 처리** (`BeginStop()`):
   ```
   - bisStoped = true
   - CurrentStopPoint 설정
   - stopTimer 초기화
   - StopPoint.bVisited = true
   - StopPoint.OnCarriageArrived() 이벤트 호출
   ```

5. **정차 타이머** (`UpdateStopTimer()`):
   ```
   - stopTimer -= DeltaTime
   - 타이머 종료 시:
     * bisStoped = false
     * StopPoint.OnCarriageDeparted() 이벤트 호출
   ```

#### 2.3 ACarriagePathActor (경로 Actor)
**역할**: Spline 기반 경로 정의 및 정류장 관리

**주요 컴포넌트**:
- `USplineComponent* PathSpline`: 경로 정의 (RootComponent)

**주요 속성**:
- `FString PathName`: 경로 이름
- `TArray<ACarriageStopPoint*> StopPoints`: 경로 상의 정류장 배열
- `float StopPointSearchRadius`: 정류장 자동 수집 반경 (기본: 500cm)

**핵심 기능**:

1. **정류장 자동 수집** (`CollectStopPoint()`):
   ```
   - 월드 내 모든 ACarriageStopPoint 검색
   - 각 정류장의 Spline 최근접 거리 계산
   - StopPointSearchRadius 이내의 정류장만 수집
   - StopIndex 기준으로 정렬
   - Editor에서 자동 갱신 (OnConstruction, PostEditChangeProperty)
   ```

2. **경로 Query API**:
   - `GetPathLength()`: Spline 전체 길이 반환
   - `GetLocationAtDistance(float)`: 거리 기준 월드 위치 반환
   - `GetRotationAtDistance(float)`: 거리 기준 월드 회전 반환
   - `FindNearestStopPoint(float Distance, float Tolerance)`:
     * 현재 거리 기준 가장 가까운 미방문 정류장 검색

**Editor 연동**:
- OnConstruction: 레벨 배치/수정 시 정류장 자동 수집
- PostEditChangeProperty: StopPointSearchRadius 변경 시 재수집

#### 2.4 ACarriageStopPoint (정류장 Actor)
**역할**: 정류장 위치 및 정차 설정 정의

**주요 컴포넌트**:
- `UBillboardComponent* BillboardComponent`: Editor 시각화

**주요 속성**:
- `FString StopName`: 정류장 이름
- `float StopDuration`: 정차 시간 (초)
- `int32 StopIndex`: 정류장 순서 (정렬 기준)
- `bool bIsTerminal`: 종점 여부 (현재 미사용)
- `bool bVisited`: 방문 여부 (런타임)

**주요 함수**:
- `ResetVisited()`: 방문 상태 초기화
- `OnCarriageArrived_Implementation()`: Blueprint 구현 가능한 도착 이벤트
- `OnCarriageDeparted_Implementation()`: Blueprint 구현 가능한 출발 이벤트

### 3. 시스템 상호작용 흐름

#### 3.1 초기화 단계 (BeginPlay)

```
[ACarriageVehicle::BeginPlay]
  └─ HasAuthority() 체크 (Server만)
      └─ StartMovement() 호출
          └─ [UCarriageMovementComponent::StartMovement]
              ├─ OwnerCarriage 유효성 체크
              ├─ CachedPathActor 유효성 체크
              ├─ HasAuthority() 체크
              ├─ bisMoving = true
              └─ SetTimer(UpdateMovement, 0.016초, 반복)

[UCarriageMovementComponent::BeginPlay]
  ├─ OwnerCarriage = Cast<ACarriageVehicle>(GetOwner())
  └─ CachedPathActor = OwnerCarriage->GetPathActor()
```

#### 3.2 이동 루프 (60fps Timer)

```
[Timer: 0.016초마다]
  └─ UpdateMovement()
      ├─ 정차 중? → UpdateStopTimer() → 리턴
      ├─ CurrentDistance += Speed * 0.016
      ├─ 경로 끝 체크
      │   ├─ Looping 모드: CurrentDistance = 0
      │   └─ 왕복 모드: Speed 반전
      ├─ NewLocation = PathActor->GetLocationAtDistance(CurrentDistance)
      ├─ NewRotation = PathActor->GetRotationAtDistance(CurrentDistance)
      ├─ SetActorLocationAndRotation(NewLocation, NewRotation)
      └─ CheckStopPoints()
          └─ NearestStop = PathActor->FindNearestStopPoint(CurrentDistance, 100)
              └─ 미방문 정류장? → BeginStop(NearestStop)
```

#### 3.3 정류장 정차 흐름

```
[CheckStopPoints]
  └─ PathActor->FindNearestStopPoint(CurrentDistance, 100cm)
      └─ [ACarriagePathActor::FindNearestStopPoint]
          ├─ StopPoints 순회
          ├─ 각 정류장의 Spline 상 거리 계산
          └─ |Distance - StopDistance| <= 100cm && !bVisited
              └─ 해당 StopPoint 반환

[BeginStop(StopPoint)]
  ├─ bisStoped = true
  ├─ CurrentStopPoint = StopPoint
  ├─ stopTimer = StopPoint->StopDuration
  ├─ StopPoint->bVisited = true
  └─ StopPoint->OnCarriageArrived(OwnerCarriage)

[UpdateStopTimer (매 0.016초)]
  ├─ stopTimer -= 0.016
  └─ stopTimer <= 0?
      ├─ bisStoped = false
      ├─ CurrentStopPoint->OnCarriageDeparted(OwnerCarriage)
      └─ CurrentStopPoint = nullptr
```

#### 3.4 Editor 정류장 수집 흐름

```
[ACarriagePathActor::OnConstruction 또는 PostEditChangeProperty]
  └─ CollectStopPoint()
      ├─ StopPoints.Empty()
      ├─ GetAllActorsOfClass(ACarriageStopPoint)
      ├─ 각 정류장 순회:
      │   ├─ StopLocation 가져오기
      │   ├─ InputKey = PathSpline->FindInputKeyClosestToWorldLocation()
      │   ├─ ClosestLocation = PathSpline->GetLocationAtSplineInputKey()
      │   ├─ Distance = Dist(ClosestLocation, StopLocation)
      │   └─ Distance <= StopPointSearchRadius?
      │       └─ StopPoints.Add(StopPoint)
      └─ StopPoints.Sort (StopIndex 기준)
```

### 4. 멀티플레이 동기화

**현재 구현 상태**:
- `ACarriageVehicle`: `bReplicates = true`, `SetReplicateMovement(true)`
- 이동 처리: Server Authority 체크 (`HasAuthority()`)
- Client는 Replication을 통해 위치/회전만 동기화

**향후 구현 필요 (Phase 4)**:
- 탑승자 정보 Replication
- 정류장 도착/출발 이벤트 동기화 (Multicast RPC)
- 클라이언트 측 예측 이동 (선택사항)

### 5. 디자인 원칙 준수 사항

✅ **Component 기반 구조**: MovementComponent로 이동 로직 분리
✅ **Tick 최소화**: Timer 기반 업데이트 (0.016초 간격)
✅ **Server Authority**: HasAuthority() 체크로 서버에서만 이동 처리
✅ **UE Framework 활용**: SplineComponent, Timer, Replication
✅ **Blueprint 확장성**: OnCarriageArrived/Departed 이벤트
✅ **Editor 편의성**: 정류장 자동 수집, EditInstanceOnly PathActor

### 6. 주요 설계 결정 및 근거

| 설계 결정 | 근거 |
|---------|------|
| Timer 기반 이동 (Tick 대신) | CLAUDE.md 원칙: "Actor Tick 최소화" |
| Component 기반 구조 | CLAUDE.md 원칙: "Component 기반 구조 설계 우선" |
| Distance 기반 위치 추적 | Spline API 활용, 정확한 경로 추종 |
| Server Authority | 멀티플레이 일관성 보장 |
| 정류장 자동 수집 | Level Designer 편의성, 휴먼 에러 감소 |
| Blueprint Event 제공 | 콘텐츠 제작자가 정류장별 커스텀 로직 추가 가능 |

### 7. 알려진 이슈 및 개선 사항

**현재 버그**:
- `CarriageMovementComponent.cpp:147`: `CurrentStopPoint`가 nullptr이 된 후 `StopName` 접근 (크래시 가능)

**개선 가능 사항**:
- 정류장 Tolerance(100cm) 하드코딩 → 설정 가능하게 변경
- FindNearestStopPoint에서 InputKey 반환값을 Distance로 사용 (단위 불일치 가능성)
- bIsTerminal 속성 미사용 → 종점 도착 시 특수 처리 로직 추가 고려

### 8. 다음 Phase 준비사항

**Phase 3 (탑승 시스템) 구현 시 필요한 연동 포인트**:
- `BoardArea (UBoxComponent)`: 탑승 가능 영역 Overlap 감지
- `ACarriageVehicle`: 탑승자 배열 추가 필요
- `UCarriageMovementComponent`: 탑승자 Transform 업데이트 로직 추가
- Enhanced Input Mapping Context 전환 (MainPlayer와 연동)
