# TTTK 251002

# Start Log
- 20251002 00:00
- 작업자 : VaVamVa

### To Do

1. "현재 진행 중인 작업 확인 및 다음 단계 결정"
    - 최근 커밋 분석 (steam socket 플러그인 추가, claude router 등)
    - 프로젝트 현재 상태 파악
    - 다음 작업 우선순위 설정

## Compact Log 1
- 20251002 00:15

### 요약 내용

Steam 기반 리슨서버 멀티플레이 환경 구축을 위한 기본 설정 완료:

1. **UE_TTTK.uproject**: OnlineSubsystemSteam 플러그인 추가
2. **DefaultEngine.ini**: Steam 온라인 서브시스템 설정 추가
   - DefaultPlatformService를 Steam으로 설정
   - SteamDevAppId=480 (개발용 Spacewar)
   - SteamNetDriver 사용하도록 NetDriverDefinitions 변경
3. **UE_TTTK.Build.cs**: Steam 관련 모듈 의존성 추가
   - OnlineSubsystem, OnlineSubsystemSteam, OnlineSubsystemUtils
4. **CLAUDE.md**: 프로젝트 문서에 새로운 모듈 및 플러그인 정보 업데이트

이제 인터넷 기반 Steam 멀티플레이가 가능한 환경이 구축되었습니다.

### Commit 정보
feat: Add Steam multiplayer support for listen server

1. "Steam 온라인 서브시스템 설정"
    - OnlineSubsystemSteam 플러그인 활성화 및 엔진 설정 추가
    - Steam 리슨서버 네트워크 드라이버 구성
2. "모듈 의존성 추가"
    - OnlineSubsystem, OnlineSubsystemSteam, OnlineSubsystemUtils 모듈 추가
3. "프로젝트 문서 업데이트"
    - CLAUDE.md에 Steam 관련 모듈 및 플러그인 정보 추가

---

### 📝 OnlineSubsystem vs Steam Sockets 비교 분석

**핵심: 두 시스템은 상호보완적이며 함께 사용됨**

#### Steam Sockets (SteamSockets 플러그인)
- **역할**: 저수준 네트워크 전송 계층
- **기능**: Steam P2P 네트워크 프로토콜 담당
- **특징**:
  - Steamworks SDK 1.46+ 기반 최신 프로토콜
  - 내장 DDoS 보호 및 종단간 암호화
  - NAT Traversal 자동 처리
  - 향상된 보안 및 안정성

#### OnlineSubsystem
- **역할**: 고수준 온라인 서비스 추상화 프레임워크
- **기능**: 세션 관리, 매치메이킹, 친구 목록, 업적 등
- **특징**:
  - 플랫폼 독립적 인터페이스 (Steam, EOS, Xbox 등)
  - CreateSession, FindSessions, JoinSession 등 고수준 API
  - Blueprint 지원

#### 통합 방식
- `OnlineSubsystemSteam.bUseSteamNetworking=true` (기본값) 설정 시:
  - OnlineSubsystem이 세션/매치메이킹 관리
  - Steam Sockets가 실제 패킷 전송 담당
  - 두 플러그인이 자동으로 통합되어 동작

#### UE 5.6 리슨서버 권장 구성
✅ **현재 설정이 최적**:
- SteamSockets 플러그인 (네트워크 전송)
- OnlineSubsystemSteam 플러그인 (세션 관리)
- 두 플러그인이 함께 작동하여 완전한 Steam 멀티플레이 구현

⚠️ **주의**: UE 5.6에서 Steam 통합 관련 호환성 이슈 보고됨 - 테스트 필요

---

## Compact Log 2
- 20251002 14:30

### 요약 내용

**AGameModeBase vs AGameMode 선택 및 미니게임 아키텍처 설계**

#### 1. GameMode 선택
- **질문**: AGameMode vs AGameModeBase 차이
- **답변**:
  - `AGameModeBase`: 경량화, Match State 없음, 단순 규칙용
  - `AGameMode`: Match State Machine 포함 (시작/종료 명확한 게임용)

#### 2. 프로젝트 게임플레이 요구사항
- **한 레벨 내 멀티플레이**:
  - 미니게임 동시 진행 가능
  - 한 플레이어는 하나의 미니게임만 참여
  - 미니게임 중이 아닌 플레이어는 마을 자유 돌아다니기 가능

#### 3. 권장 아키텍처
**`AGameModeBase` + 독립 미니게임 Manager Actor 구조**

```
AGameModeBase (레벨 전체 관리)
└── 각 미니게임 = Actor/Component
    ├── 달리기 대결 Manager
    ├── 윷놀이 Manager
    └── 기타 미니게임 Manager
```

**이유**:
- GameMode는 레벨당 하나만 존재
- 여러 미니게임 동시 진행 필요 → 각 미니게임이 독립 State 관리
- Match State는 미니게임 레벨이 아닌 개별 Manager가 관리

#### 4. 미니게임 구성 계획
- **총 4개 미니게임**:
  - 턴제 2개
  - 실시간 2개
  - 팀전 1개 (턴제/실시간 미정)

#### 5. 설계 고려사항

**공통 베이스 클래스 구조 제안**:
```cpp
AMinigameManagerBase
├── bAllowMidGameQuit (미니게임별 설정)
├── MinPlayerCount / MaxPlayerCount
├── StartCondition (Auto/Manual/Ready)
├── bIsTeamBased
└── Virtual Functions (StartGame/EndGame/OnPlayerJoin/OnPlayerQuit)
```

**미니게임별 특성**:
- **턴제**: 중도 퇴장 제한 권장 (`bAllowMidGameQuit = false`)
- **실시간**: 중도 퇴장 허용 가능 (`bAllowMidGameQuit = true`)
- **팀전**: 팀 배정 방식, 팀원 대기 로직 필요

**중복 참여 방지**:
- 각 플레이어 Pawn/Controller에 `CurrentMinigame` 변수로 관리

**추가 기능**:
- 로비/대기 UI 필요 (참가자 목록, 준비 상태 등)

#### 6. 미정 사항
- 팀전 미니게임이 턴제/실시간 여부
- 시작 조건 방식 (자동/수동/하이브리드)
- 팀 배정 방식
- 재참여 정책 (쿨타임 등)
- 보상/기록 시스템 저장 위치

### 추후 고민 필요
1. 네트워크 동기화 범위 (Relevancy, 관전 기능)
2. 재참여 정책 및 쿨타임
3. 결과 저장 시스템 (PlayerState vs SaveGame)

---

## Compact Log 3
- 20251002 23:45

### 요약 내용

**Steam 세션 생성/검색 로직 구현 및 SEARCH_PRESENCE 개념 학습**

#### 1. Steam 마켓 등록 없이 개발 환경 구축
- **Spacewar (AppID 480)** 사용
  - Steam 계정만 있으면 평생 무료 테스트 가능
  - 마켓 등록 전까지 계속 사용
  - Listen Server 방식 (Dedicated Server 제외)

#### 2. Steam 세션 생성/검색/참가 로직
- **세션 생성 (Host)**:
  - `CreateSession()` + `FOnlineSessionSettings`
  - `bUsesPresence = true` (친구 찾기)
  - `bAllowJoinViaPresence = true` (친구 직접 참가)
  - `bIsLANMatch = false` (인터넷 기반)

- **세션 검색 (Client)**:
  - `FindSessions()` + `FOnlineSessionSearch`
  - `SEARCH_PRESENCE` 설정으로 친구 기반 검색

- **세션 참가 (Client)**:
  - `JoinSession()` + `ClientTravel()`

#### 3. SEARCH_PRESENCE 개념
- **Presence**: Steam 친구 목록의 "현재 상태" 정보
- **`SEARCH_PRESENCE = true`**: 친구 기반 세션 검색
  - Steam 친구/친구의 친구 세션만 검색
  - P2P 친구 네트워크 기반 매치메이킹
  - 전용 서버 목록 없어도 작동

- **매크로 정의 이슈**:
  - `SEARCH_PRESENCE`는 엔진 소스 `OnlineSessionSettings.h`에 정의
  - UE 5.6에서 접근 불가 → `FName(TEXT("PRESENCE"))` 직접 사용

#### 4. SessionSearch 생명주기 문제 해결
- **문제**: 비동기 Callback에서 검색 결과 접근 필요
- **해결**: 멤버 변수화
  - `TSharedPtr<FOnlineSessionSearch> sessionSearch;` (헤더)
  - `sessionSearch = MakeShareable(new FOnlineSessionSearch());` (구현)
  - `sessions->FindSessions(0, sessionSearch.ToSharedRef());`

#### 5. 수정된 파일
- **MainMenuSteam.h**:
  - `TSharedPtr<FOnlineSessionSearch> sessionSearch;` 멤버 변수 추가
  - `class FOnlineSessionSearch;` 전방 선언 추가

- **MainMenuSteam.cpp**:
  - `ClickFindButton()`: sessionSearch 멤버 변수로 수정
  - `FName(TEXT("PRESENCE"))` 직접 사용
  - `ToSharedRef()` 변환 적용

### Commit 정보
feat: Implement Steam session search with Presence

1. "Steam 세션 검색 로직 구현"
    - FOnlineSessionSearch를 멤버 변수로 관리하여 비동기 Callback 대응
    - SEARCH_PRESENCE (친구 기반 검색) 설정 적용
2. "SessionSearch 생명주기 관리"
    - TSharedPtr로 멤버 변수화하여 검색 결과 유지
    - ToSharedRef() 변환으로 FindSessions() 호출

### 다음 단계
- `OnFindSessionComplete()` 구현 (검색 결과 UI 표시)
- `JoinSession()` 로직 구현
- Steam 친구 초대 기능 검토

---

## End Log
- 20251002 23:50
- 작업자 : VaVamVa

### 오늘 한 일

1. **Steam 멀티플레이 기초 구축** (Compact Log 1)
   - OnlineSubsystemSteam 플러그인 및 모듈 설정
   - Spacewar (AppID 480) 개발 환경 구성

2. **미니게임 아키텍처 설계** (Compact Log 2)
   - AGameModeBase + 독립 미니게임 Manager 구조 결정
   - 4개 미니게임 (턴제 2개, 실시간 2개, 팀전 1개) 설계

3. **Steam 세션 검색 로직 구현** (Compact Log 3)
   - SEARCH_PRESENCE 개념 학습 (친구 기반 검색)
   - SessionSearch 생명주기 관리 (TSharedPtr 멤버 변수화)
   - MainMenuSteam 클래스에 세션 검색 기능 추가
