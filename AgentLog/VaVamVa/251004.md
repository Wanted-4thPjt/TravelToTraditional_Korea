# TTTK 251004

# Start Log
- 20251004 현재시각
- 작업자 : VaVamVa

### To Do

1. 인게임 컨텐츠 체험 시스템 구축
    - Content Entry NPC 구현
        - 플레이어와 상호작용 가능한 NPC Actor 생성
        - NPC 대화/UI 트리거 시스템
    - Content Entry Actor Component 구현
        - 컨텐츠 진입 로직을 모듈화한 Component
        - 재사용 가능한 구조로 설계
    - Variant 컨텐츠 연동 (Combat, SideScrolling, Platforming)

2. Steam 네트워크 시스템 완성 및 테스트
    - Steam Session Subsystem 검증
    - 세션 생성/조회/참가 기능 확인
    - UI 연동 상태 점검

3. 멀티플레이 기본 기능 구현
    - 플레이어 스폰 및 동기화
    - 네트워크 레플리케이션 설정

4. 조선시대 마을 레벨 준비
    - 맵 로딩 시스템 확인 (PDA_MapList 활용)
    - 기본 플레이어 이동 및 상호작용 테스트

---

## Compact Log 1
- 20251005 02:42

### 요약 내용

**ContentEntryComponent 설계 및 완전 구현 완료**

#### 1. 아키텍처 설계
- **하나의 레벨에서 여러 컨텐츠 동시 진행** 구조 확립
  - 레벨 전환 없이 같은 레벨 내에서 컨텐츠 영역 이동
  - 각 컨텐츠는 독립 Manager Actor로 관리
  - Host = 컨텐츠 세션의 방장 (서버 호스트와 별개)

- **컴포넌트 기반 모듈화 설계**
  - ContentEntryComponent: 대기실(Lobby) 관리 및 컨텐츠 진입 트리거
  - ContentNPC: Component를 소유하는 NPC Character
  - BaseContentManager: 실제 컨텐츠 로직 관리 (추후 구현)

#### 2. ContentEntryComponent 구현
**파일 구조:**
- `Public/NPC/ContentEntryComponent.h`
- `Private/NPC/ContentEntryComponent.cpp`
- `Public/Data/ContentEntrySettings.h` (FContentEntrySettings Struct)

**주요 기능:**
- **대기실(Lobby) 시스템**
  - SphereComponent로 범위 내 Player 감지
  - 첫 입장자가 Host로 지정
  - 입장/퇴장/시작/취소 기능
  - 타임아웃 처리 (maxWaitSeconds)

- **네트워크 동기화 (Replication & RPC)**
  - Server RPC: `Server_RequestJoin`, `Server_RequestLeave`, `Server_RequestStart`, `Server_RequestCancel`
  - Multicast RPC: `Multicast_UpdateLobbyState`, `Multicast_OnContentStarted`, `Multicast_OnContentFinished`, `Multicast_OnLobbyCancelled`
  - Replicated 변수: playersInRange, readyPlayers, hostPlayer, bLobbyActive, bContentRunning

- **시작 조건 검증**
  - EStartCondition: Auto (인원 충족 시 자동), Manual (Host가 시작), Ready (모두 Ready 필요)
  - 최소/최대 인원 검증
  - 컨텐츠별 커스텀 설정 (FContentEntrySettings)

**호출 흐름:**
```
Client: RequestJoinLobby()
  → Server RPC: Server_RequestJoin()
    → 검증: ValidateJoinRequest()
    → 추가: AddPlayerToLobby()
  → Multicast: Multicast_UpdateLobbyState()
    → All Clients: UI 업데이트
```

#### 3. 컨텐츠별 설정 시스템
**FContentEntrySettings Struct:**
- 기본 정보: contentName, contentDescription, mappingMode
- 인원 제한: minPlayers, maxPlayers
- 실행 조건: startCondition, bAllowMidGameQuit, bIsTeamBased
- 시간: timeLimitSeconds
- 스폰: playerSpawnTransforms
- 커스텀: customSettings (TMap<FName, FString>)
- UI: thumbnailImage, uiAccentColor

#### 4. 학습한 개념 및 기술

**1) SetIsReplicated vs SetIsReplicatedByDefault**
- `SetIsReplicatedByDefault(true)`: Constructor에서 사용 (Default Subobject Component용)
- `SetIsReplicated(true)`: 런타임에 동적 생성된 Component용
- ~~`SetIsReplicatedComponent(true)`~~: 존재하지 않는 함수

**2) TSet vs TArray 선택**
- TArray 선택 이유:
  - 입장 순서 보존 필요 (Host = 첫 번째)
  - UI 표시용 순서 유지
  - Replication 지원 (TSet은 미지원)

**3) RPC (Remote Procedure Call) 개념**
- **Server RPC**: Client → Server 요청
  ```cpp
  UFUNCTION(Server, Reliable)
  void Server_RequestJoin(AMainPlayer* player);

  // 구현: 함수명 + _Implementation
  void UContentEntryComponent::Server_RequestJoin_Implementation(...)
  ```

- **Multicast RPC**: Server → All Clients 브로드캐스트
  ```cpp
  UFUNCTION(NetMulticast, Reliable)
  void Multicast_UpdateLobbyState();

  void UContentEntryComponent::Multicast_UpdateLobbyState_Implementation(...)
  ```

- **Reliable vs Unreliable**
  - Reliable: 보장된 전송, 재전송 시도 (중요한 게임플레이 로직)
  - Unreliable: 손실 허용, 대역폭 절약 (위치 업데이트, 이펙트 등)

- **RPC 키워드**
  - `Server`: Client → Server
  - `Client`: Server → 특정 Client (Owner)
  - `NetMulticast`: Server → All Clients
  - `Remote`: Deprecated (사용 금지)

**4) GetLifetimeReplicatedProps 사용법**
```cpp
#include "Net/UnrealNetwork.h"

void UContentEntryComponent::GetLifetimeReplicatedProps(TArray<FLifetimeProperty>& OutLifetimeProps) const
{
    Super::GetLifetimeReplicatedProps(OutLifetimeProps);

    DOREPLIFETIME(UContentEntryComponent, playersInRange);
    DOREPLIFETIME(UContentEntryComponent, readyPlayers);
    // ...
}
```

**5) HasAuthority 사용법 (ActorComponent)**
```cpp
// ActorComponent는 직접 HasAuthority() 없음
// GetOwner()->HasAuthority() 사용

bool UContentEntryComponent::IsServer() const
{
    AActor* owner = GetOwner();
    return IsValid(owner) && owner->HasAuthority();
}

// 또는 GetOwnerRole() 사용
if (GetOwnerRole() == ROLE_Authority) { /* 서버 */ }
```

#### 5. 설계 개선 과정
- **중복 함수 제거**:
  - ❌ `OnPlayerReadyToJoin()`, `ServerRequestJoin()`, `StartContent()` 등
  - ✅ 명확한 책임 분리: Public → Server RPC → Internal → Multicast

- **함수 명명 일관성**:
  - Public: `Request*` (UI/Blueprint 호출용)
  - Server RPC: `Server_Request*`
  - Multicast RPC: `Multicast_*`
  - Internal: 검증/로직 함수

- **Player 파라미터 처리**:
  - ~~GetOwner() 사용~~ → Player를 파라미터로 전달

### TODO (추후 구현)
1. ContentNPC 구현 (Component 소유, 외곽선, Widget)
2. BaseContentManager 설계 및 구현
3. Player 외곽선 시스템 (LineTrace + Custom Depth)
4. UI 연동 (Join/Start 버튼)
5. 컨텐츠별 Manager (Combat, SideScrolling, Platforming)

### Commit 정보
feat: Implement ContentEntryComponent with full networking support

1. "ContentEntryComponent 완전 구현"
   - Lobby 시스템 (Join/Leave/Start/Cancel)
   - Server RPC 및 Multicast RPC 구현
   - Replication 설정 완료
2. "컨텐츠별 설정 시스템"
   - FContentEntrySettings Struct 설계
   - 컨텐츠 타입별 커스터마이즈 가능
3. "네트워크 아키텍처 확립"
   - 명확한 RPC 흐름 (Client → Server → All Clients)
   - Authority 체크 및 검증 로직

---

## End Log
- 20251005 02:46
- 작업자 : VaVamVa

### 미구현 TODO 정리

#### 1. ContentEntryComponent (컨텐츠 진입 시스템)
**파일**: `Private/NPC/ContentEntryComponent.cpp`

- [ ] **OnContentFinished() - 플레이어 복귀** (Line 96)
  - 플레이어를 원래 위치로 이동시키는 로직
  - 원래 위치 저장 메커니즘 필요

- [ ] **OnContentFinished() - ContentManager 삭제** (Line 99-105)
  - ContentManager Destroy 및 nullptr 처리

- [ ] **Multicast_OnContentStarted() - 시작 연출** (Line 181)
  - 컨텐츠 시작 시 연출, UI 변경
  - 로딩 스크린, 사운드, 카메라 전환 등

- [ ] **Multicast_OnContentFinished() - 결과 표시** (Line 187)
  - 결과 UI 표시, 보상 연출

- [ ] **ValidateStartRequest() - Ready 모드 검증** (Line 264-274)
  - Player에 bIsReady 변수 추가 필요
  - 모든 플레이어 Ready 상태 체크

- [ ] **StartContentInternal() - ContentManager 생성** (Line 358-377)
  - ContentManagerClass 기반 Manager 스폰
  - Manager에 readyPlayers 전달
  - StartContent() 호출

- [ ] **StartContentInternal() - 플레이어 이동** (Line 379-391)
  - playerSpawnTransforms로 플레이어 Teleport
  - 인덱스별 Transform 할당

#### 2. ContentNPC (NPC Actor)
**파일**: `Public/NPC/ContentNPC.h`, `Private/NPC/ContentNPC.cpp`

- [ ] **ContentEntryComponent 연결**
  - Component 생성 및 초기화
  - Owner 설정

- [ ] **외곽선 시스템**
  - Player LineTrace 감지
  - CustomDepth + Post Process 설정
  - 외곽선 활성화/비활성화

- [ ] **Widget Component 추가**
  - Interact Widget 표시
  - 컨텐츠 정보 표시 (이름, 인원 등)
  - Host/일반 플레이어별 UI 차별화

- [ ] **NPC 애니메이션/외형**
  - 컨텐츠별 NPC Mesh 설정
  - 대화 애니메이션

#### 3. BaseContentManager (컨텐츠 관리자)
**새로 생성 필요**: `Public/Managers/BaseContentManager.h`, `Private/Managers/BaseContentManager.cpp`

- [ ] **BaseContentManager 설계**
  - AActor 상속
  - Virtual 함수 정의
    - StartContent(TArray<AMainPlayer*> players)
    - EndContent()
    - OnPlayerQuit(AMainPlayer* player)

- [ ] **상태 관리**
  - EContentState (Waiting/Running/Finished)
  - Participants 관리
  - 결과 계산

- [ ] **구체적 Manager 구현**
  - ACombatContentManager
  - ASideScrollingContentManager
  - APlatformingContentManager

#### 4. SteamSessionSubsystem (Steam 네트워크)
**파일**: `Private/Network/SteamSessionSubsystem.cpp`

- [ ] **FindSession() 구현** (Line 53-55)
  - sessionSearch 설정
  - SEARCH_PRESENCE 설정
  - FindSessions() 호출
  - Delegate 바인딩

- [ ] **JoinSession() 구현** (Line 57-59)
  - 선택한 세션에 참가
  - ClientTravel() 호출

- [ ] **OnCompleteCreateSession() - ServerTravel** (Line 65)
  - 주석 처리된 ServerTravel 활성화
  - 맵 경로 설정 로직

- [ ] **OnCompleteFindSession() 구현** (Line 69-71)
  - 검색 결과 처리
  - UI에 세션 목록 전달

- [ ] **세션 설정 관리**
  - SteamSessionSettings 활용
  - 맵별 MaxPlayers 설정

#### 5. MainMenuSteam (Steam UI)
**파일**: `Private/UI/MainMenuSteam.cpp`

- [ ] **CreateHost() - 세션 생성 연동** (Line 33-36)
  - SteamSessionSubsystem 호출
  - 맵 선택 UI 추가
  - 인원 설정 UI

- [ ] **OnCompleteCreateSession() 구현** (Line 38-41)
  - 성공 시 처리
  - 실패 시 에러 UI

- [ ] **ClickFindButton() - UI 바인딩** (Line 43-64)
  - findButton에 Delegate 바인딩
  - 현재 함수만 작성되고 버튼 연결 안됨

- [ ] **OnFindSessionComplete() - 결과 표시** (Line 66-70)
  - 주석 처리된 results 활용
  - SessionsList에 결과 전달
  - UI 표시

#### 6. MainMenu Children Widgets
**파일**: `Public/UI/CreatingSession.h`, `Public/UI/SessionsList.h`, `Public/UI/SessionNode.h`

- [ ] **CreatingSession Widget**
  - 세션 생성 중 로딩 UI
  - 취소 버튼
  - 진행 상태 표시

- [ ] **SessionsList Widget**
  - 검색된 세션 목록 표시
  - ListView/ScrollBox 활용
  - SessionNode로 각 항목 표시

- [ ] **SessionNode Widget**
  - 개별 세션 정보 표시
  - 참가 버튼
  - 호스트 이름, 인원, 핑 등

#### 7. Player 상호작용 시스템
**파일**: `Public/MainPlayer.h`, `Private/MainPlayer.cpp`

- [ ] **LineTrace 시스템**
  - 주기적으로 전방 Trace
  - Interactable 감지
  - 외곽선 대상 업데이트

- [ ] **Interact Input**
  - Enhanced Input 설정
  - Interact Action 추가
  - ContentEntryComponent 호출

- [ ] **Player 상태 관리**
  - CurrentContent 변수 (중복 참여 방지)
  - bIsReady 변수 (Ready 모드용)
  - 원래 위치 저장

### 우선순위
1. **High**: ContentNPC 완성 → BaseContentManager 설계
2. **Medium**: SteamSessionSubsystem 완성 → MainMenuSteam UI 연동
3. **Low**: Player 시스템 개선 → 세부 연출/UI
